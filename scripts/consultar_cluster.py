# ./scripts/consultar_cluster.py

import os
import json
import sys
import requests
import pandas as pd
from datetime import datetime, timedelta
from typing import Dict, Optional, List

# Agregar el directorio ra√≠z al path
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))


def cargar_configuracion_empresa() -> Optional[Dict]:
    """
    Cargar configuraci√≥n de la empresa desde archivo.

    Returns
    -------
    Optional[Dict]
        Configuraci√≥n de la empresa o None si no existe
    """
    try:
        with open("config/empresa.json", "r") as f:
            return json.load(f)
    except FileNotFoundError:
        print("‚ùå No se encontr√≥ configuraci√≥n de empresa")
        print("   Ejecuta primero: python scripts/configurar_empresa.py")
        return None
    except Exception as e:
        print(f"‚ùå Error cargando configuraci√≥n: {e}")
        return None


def consultar_metricas_generales(api_url: str) -> Optional[Dict]:
    """
    Consultar m√©tricas generales del cl√∫ster.

    Parameters
    ----------
    api_url : str
        URL de la API del cl√∫ster

    Returns
    -------
    Optional[Dict]
        M√©tricas generales o None si hay error
    """
    try:
        print("üìä Consultando m√©tricas generales del cl√∫ster...")
        response = requests.get(f"{api_url}/metrics/general", timeout=30)

        if response.status_code == 200:
            return response.json()
        else:
            print(f"‚ùå Error consultando m√©tricas: {response.status_code}")
            return None

    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error de conexi√≥n: {e}")
        print("   Verifica que la API est√© funcionando")
        return None


def consultar_metricas_por_giro(api_url: str, giro: str) -> Optional[Dict]:
    """
    Consultar m√©tricas espec√≠ficas de un giro.

    Parameters
    ----------
    api_url : str
        URL de la API del cl√∫ster
    giro : str
        Giro tur√≠stico a consultar

    Returns
    -------
    Optional[Dict]
        M√©tricas del giro o None si hay error
    """
    try:
        print(f"üè∑Ô∏è Consultando m√©tricas para giro: {giro}")
        response = requests.get(f"{api_url}/metrics/by-sector/{giro}", timeout=30)

        if response.status_code == 200:
            return response.json()
        elif response.status_code == 404:
            print(f"‚ö†Ô∏è No hay datos suficientes para el giro {giro}")
            return None
        else:
            print(f"‚ùå Error consultando giro: {response.status_code}")
            return None

    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error de conexi√≥n: {e}")
        return None


def consultar_modelos_agregados(api_url: str) -> Dict[str, Optional[Dict]]:
    """
    Consultar modelos agregados disponibles.

    Parameters
    ----------
    api_url : str
        URL de la API del cl√∫ster

    Returns
    -------
    Dict[str, Optional[Dict]]
        Diccionario con modelos disponibles
    """
    modelos = {}
    tipos_modelo = ["prediccion_demanda", "clasificacion_viajero"]

    for tipo in tipos_modelo:
        try:
            print(f"ü§ñ Consultando modelo: {tipo}")
            response = requests.get(f"{api_url}/federated/get-aggregated/{tipo}", timeout=30)

            if response.status_code == 200:
                modelos[tipo] = response.json()
                print(f"‚úÖ Modelo {tipo} disponible")
            elif response.status_code == 404:
                print(f"‚ö†Ô∏è Modelo {tipo} no disponible a√∫n")
                modelos[tipo] = None
            else:
                print(f"‚ùå Error consultando {tipo}: {response.status_code}")
                modelos[tipo] = None

        except requests.exceptions.RequestException as e:
            print(f"‚ùå Error de conexi√≥n para {tipo}: {e}")
            modelos[tipo] = None

    return modelos


def mostrar_metricas_generales(metricas: Dict):
    """
    Mostrar m√©tricas generales del cl√∫ster de forma clara.

    Parameters
    ----------
    metricas : Dict
        M√©tricas generales del cl√∫ster
    """
    print("\n" + "=" * 60)
    print("üìä M√âTRICAS GENERALES DEL CL√öSTER")
    print("=" * 60)

    if 'metricas_economicas' in metricas:
        economicas = metricas['metricas_economicas']

        print("üí∞ INDICADORES ECON√ìMICOS:")
        print(f"  Ingresos totales del cl√∫ster: ${economicas.get('ingresos_totales_cluster', 0):,.0f}")
        print(f"  Ingreso promedio diario: ${economicas.get('ingreso_promedio_diario', 0):,.0f}")
        print(f"  Clientes totales atendidos: {economicas.get('clientes_totales_atendidos', 0):,}")
        print(f"  Ticket promedio del cl√∫ster: ${economicas.get('ticket_promedio_cluster', 0):,.0f}")

    if 'metricas_eventos' in metricas:
        eventos = metricas['metricas_eventos']

        print("\nüé™ INDICADORES DE EVENTOS:")
        print(f"  Total de eventos realizados: {eventos.get('total_eventos_realizados', 0):,}")
        print(f"  Asistentes totales: {eventos.get('asistentes_totales', 0):,}")
        print(f"  Asistentes promedio por evento: {eventos.get('asistentes_promedio_evento', 0):.0f}")
        print(f"  Ocupaci√≥n promedio: {eventos.get('ocupacion_promedio_eventos', 0):.1f}%")

    if 'perfil_viajeros' in metricas:
        viajeros = metricas['perfil_viajeros']

        print("\nüë• PERFIL DE VIAJEROS:")
        print(f"  Total de perfiles analizados: {viajeros.get('total_perfiles_analizados', 0):,}")
        print(f"  Gasto promedio por viajero: ${viajeros.get('gasto_promedio_viajero', 0):,.0f}")
        print(f"  Estancia promedio: {viajeros.get('estancia_promedio_dias', 0):.1f} d√≠as")
        print(f"  Tipos de viajero: {viajeros.get('tipos_viajero_representados', 0)}")


def mostrar_metricas_giro(metricas: Dict, giro: str):
    """
    Mostrar m√©tricas espec√≠ficas de un giro.

    Parameters
    ----------
    metricas : Dict
        M√©tricas del giro
    giro : str
        Nombre del giro
    """
    print(f"\n" + "=" * 60)
    print(f"üè∑Ô∏è M√âTRICAS DEL GIRO: {giro.upper()}")
    print("=" * 60)

    if 'metricas_economicas' in metricas:
        economicas = metricas['metricas_economicas']

        print("üí∞ RENDIMIENTO ECON√ìMICO:")
        print(f"  Ingresos totales: ${economicas.get('ingresos_totales', 0):,.0f}")
        print(f"  Ingresos promedio diario: ${economicas.get('ingresos_promedio_diario', 0):,.0f}")
        print(f"  Clientes totales: {economicas.get('clientes_totales', 0):,}")
        print(f"  Clientes promedio diario: {economicas.get('clientes_promedio_diario', 0):.0f}")
        print(f"  Precio promedio: ${economicas.get('precio_promedio', 0):,.0f}")

    if 'patrones_temporales' in metricas:
        patrones = metricas['patrones_temporales']

        print("\nüìÖ PATRONES TEMPORALES:")
        if 'mejor_mes' in patrones:
            mejor_mes = patrones['mejor_mes']
            print(f"  Mejor mes: {mejor_mes.get('mes', 'N/A')} (${mejor_mes.get('ingresos', 0):,.0f})")

        if 'mejor_dia_semana' in patrones:
            mejor_dia = patrones['mejor_dia_semana']
            print(f"  Mejor per√≠odo: {mejor_dia.get('tipo', 'N/A')} (factor: {mejor_dia.get('factor', 1):.2f}x)")

    if 'comparacion_cluster' in metricas:
        comparacion = metricas['comparacion_cluster']

        print("\nüìä COMPARACI√ìN CON EL CL√öSTER:")
        print(f"  Participaci√≥n en ingresos: {comparacion.get('participacion_ingresos', 0):.2f}%")
        print(f"  Participaci√≥n en clientes: {comparacion.get('participacion_clientes', 0):.2f}%")


def mostrar_modelos_disponibles(modelos: Dict[str, Optional[Dict]]):
    """
    Mostrar informaci√≥n sobre modelos agregados disponibles.

    Parameters
    ----------
    modelos : Dict[str, Optional[Dict]]
        Diccionario con modelos disponibles
    """
    print(f"\n" + "=" * 60)
    print("ü§ñ MODELOS AGREGADOS DISPONIBLES")
    print("=" * 60)

    for tipo_modelo, modelo in modelos.items():
        print(f"\nüìà {tipo_modelo.replace('_', ' ').title()}:")

        if modelo:
            print(f"  ‚úÖ Disponible")
            print(f"  Contribuciones: {modelo.get('num_contribuciones', 0)} empresas")
            print(f"  Confianza: {modelo.get('confianza', 0):.3f}")
            print(f"  √öltima actualizaci√≥n: {modelo.get('timestamp_agregacion', 'N/A')}")

            if 'metricas_agregadas' in modelo:
                metricas = modelo['metricas_agregadas']
                print(f"  M√©tricas:")
                for metrica, valor in metricas.items():
                    if isinstance(valor, float):
                        print(f"    {metrica}: {valor:.3f}")
                    else:
                        print(f"    {metrica}: {valor}")
        else:
            print(f"  ‚ùå No disponible")
            print(f"  Se necesitan m√°s contribuciones de empresas")


def generar_recomendaciones(configuracion: Dict, metricas_generales: Optional[Dict],
                            metricas_giro: Optional[Dict], modelos: Dict[str, Optional[Dict]]):
    """
    Generar recomendaciones personalizadas para la empresa.

    Parameters
    ----------
    configuracion : Dict
        Configuraci√≥n de la empresa
    metricas_generales : Optional[Dict]
        M√©tricas generales del cl√∫ster
    metricas_giro : Optional[Dict]
        M√©tricas del giro de la empresa
    modelos : Dict[str, Optional[Dict]]
        Modelos disponibles
    """
    print(f"\n" + "=" * 60)
    print("üí° RECOMENDACIONES PERSONALIZADAS")
    print("=" * 60)

    giro = configuracion['empresa']['giro']
    nombre = configuracion['empresa']['nombre']

    print(f"üè¢ Para: {nombre} ({giro})")
    print()

    recomendaciones = []

    # Recomendaciones basadas en m√©tricas del giro
    if metricas_giro and 'patrones_temporales' in metricas_giro:
        patrones = metricas_giro['patrones_temporales']

        if 'mejor_mes' in patrones:
            mes = patrones['mejor_mes'].get('mes', 0)
            if mes:
                recomendaciones.append(f"üìÖ Optimiza tu operaci√≥n para el mes {mes} (mejor rendimiento del giro)")

        if 'mejor_dia_semana' in patrones:
            tipo_dia = patrones['mejor_dia_semana'].get('tipo', '')
            factor = patrones['mejor_dia_semana'].get('factor', 1)
            if factor > 1.2:
                recomendaciones.append(f"üìà Enf√≥cate en {tipo_dia} (rendimiento {factor:.1f}x superior)")

    # Recomendaciones basadas en modelos disponibles
    if modelos.get('prediccion_demanda'):
        recomendaciones.append("üîÆ Usa el modelo de predicci√≥n para planificar inventario y personal")

    if modelos.get('clasificacion_viajero'):
        recomendaciones.append("üë• Aplica el modelo de clasificaci√≥n para personalizar ofertas")

    # Recomendaciones basadas en comparaci√≥n con el cl√∫ster
    if metricas_giro and 'comparacion_cluster' in metricas_giro:
        participacion = metricas_giro['comparacion_cluster'].get('participacion_ingresos', 0)
        if participacion < 1.0:  # Menos del 1% del cl√∫ster
            recomendaciones.append("üìä Considera estrategias de crecimiento basadas en mejores pr√°cticas del cl√∫ster")

    # Mostrar recomendaciones
    if recomendaciones:
        for i, rec in enumerate(recomendaciones, 1):
            print(f"{i}. {rec}")
    else:
        print("üìä Contin√∫a participando en el cl√∫ster para obtener m√°s insights")

    # Pr√≥ximos pasos
    print(f"\nüéØ PR√ìXIMOS PASOS SUGERIDOS:")
    print(f"1. Ejecuta predicciones espec√≠ficas: python scripts/predecir_demanda.py")
    print(f"2. Haz benchmarking detallado: python scripts/benchmark_anonimo.py")
    print(f"3. Analiza tendencias estacionales: python scripts/analizar_tendencias.py")
    print(f"4. Vuelve a entrenar modelos: python scripts/entrenar_y_enviar.py")


def guardar_reporte_consulta(configuracion: Dict, metricas_generales: Optional[Dict],
                             metricas_giro: Optional[Dict], modelos: Dict[str, Optional[Dict]]):
    """
    Guardar reporte de la consulta para referencia futura.

    Parameters
    ----------
    configuracion : Dict
        Configuraci√≥n de la empresa
    metricas_generales : Optional[Dict]
        M√©tricas generales
    metricas_giro : Optional[Dict]
        M√©tricas del giro
    modelos : Dict[str, Optional[Dict]]
        Modelos disponibles
    """
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")

    reporte = {
        "empresa": {
            "nombre": configuracion['empresa']['nombre'],
            "giro": configuracion['empresa']['giro'],
            "id": configuracion['empresa']['id']
        },
        "timestamp_consulta": datetime.now().isoformat(),
        "metricas_generales": metricas_generales,
        "metricas_giro": metricas_giro,
        "modelos_disponibles": {
            tipo: modelo is not None for tipo, modelo in modelos.items()
        },
        "resumen_modelos": {
            tipo: {
                "disponible": modelo is not None,
                "contribuciones": modelo.get('num_contribuciones', 0) if modelo else 0,
                "confianza": modelo.get('confianza', 0) if modelo else 0
            } for tipo, modelo in modelos.items()
        }
    }

    # Crear directorio de reportes
    os.makedirs("reportes_cluster", exist_ok=True)

    archivo_reporte = f"reportes_cluster/consulta_{timestamp}.json"
    with open(archivo_reporte, "w") as f:
        json.dump(reporte, f, indent=2)

    print(f"\nüíæ Reporte guardado: {archivo_reporte}")


def main():
    """
    Funci√≥n principal del script de consulta del cl√∫ster.
    """
    print("üìä CONSULTA DEL CL√öSTER - TURISMO NL")
    print("=" * 60)
    print("Consultando resultados agregados del cl√∫ster para tu empresa")
    print("üîí Solo recibes informaci√≥n agregada, nunca datos individuales")
    print()

    # Cargar configuraci√≥n
    configuracion = cargar_configuracion_empresa()
    if not configuracion:
        return False

    print(f"‚úÖ Configuraci√≥n cargada para: {configuracion['empresa']['nombre']}")
    print(f"üè∑Ô∏è Giro: {configuracion['empresa']['giro']}")

    api_url = configuracion['conexion']['api_url']
    giro = configuracion['empresa']['giro']

    # Consultar m√©tricas generales
    metricas_generales = consultar_metricas_generales(api_url)
    if metricas_generales:
        mostrar_metricas_generales(metricas_generales)

    # Consultar m√©tricas del giro espec√≠fico
    metricas_giro = consultar_metricas_por_giro(api_url, giro)
    if metricas_giro:
        mostrar_metricas_giro(metricas_giro, giro)

    # Consultar modelos agregados
    modelos = consultar_modelos_agregados(api_url)
    mostrar_modelos_disponibles(modelos)

    # Generar recomendaciones
    generar_recomendaciones(configuracion, metricas_generales, metricas_giro, modelos)

    # Guardar reporte
    guardar_reporte_consulta(configuracion, metricas_generales, metricas_giro, modelos)

    return True


if __name__ == "__main__":
    try:
        exito = main()
        if exito:
            print(f"\nüéâ ¬°Consulta completada exitosamente!")
            print(f"üìä Usa esta informaci√≥n para tomar mejores decisiones de negocio")
        else:
            print(f"\nüí• La consulta no se pudo completar")
            sys.exit(1)
    except KeyboardInterrupt:
        print(f"\n‚èπÔ∏è Consulta cancelada por el usuario")
        sys.exit(1)
    except Exception as e:
        print(f"\n‚ùå Error inesperado: {e}")
        sys.exit(1)
